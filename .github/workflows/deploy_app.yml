name: ðŸš€ Deploy FastAPI App on AWS EC2

on:
  workflow_dispatch:  # Trigger manually

env:
  AWS_REGION: 'us-east-1'

jobs:
  deploy:
    name: Deploy FastAPI App
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Check and create EC2 key pair if needed
      id: keypair
      run: |
        set -e

        KEY_NAME="fastapi-key"

        echo "Checking if key pair $KEY_NAME exists..."
        EXISTS=$(aws ec2 describe-key-pairs --key-names $KEY_NAME --query 'KeyPairs[0].KeyName' --output text 2>/dev/null || echo "NotFound")

        if [ "$EXISTS" = "$KEY_NAME" ]; then
          echo "Key pair $KEY_NAME exists, skipping creation."
        else
          echo "Key pair $KEY_NAME not found. Creating..."
          aws ec2 create-key-pair --key-name $KEY_NAME --query 'KeyMaterial' --output text > ${KEY_NAME}.pem
          chmod 400 ${KEY_NAME}.pem
          echo "Key pair created and saved as ${KEY_NAME}.pem"
        fi

        echo "KEY_NAME=$KEY_NAME" >> $GITHUB_ENV
        echo "KEY_FILE=${KEY_NAME}.pem" >> $GITHUB_ENV

    
    - name: Lookup VPC/Subnet/SG dynamically
      run: |
        # Get default VPC ID
        VPC_ID=$(aws ec2 describe-vpcs --filters "Name=isDefault,Values=true" --query 'Vpcs[0].VpcId' --output text)
        echo "VPC_ID=$VPC_ID" >> $GITHUB_ENV

        # Get subnet in that VPC
        SUBNET_ID=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" --query 'Subnets[0].SubnetId' --output text)
        echo "SUBNET_ID=$SUBNET_ID" >> $GITHUB_ENV

        # Get a security group in that VPC
        SG_ID=$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$VPC_ID" --query 'SecurityGroups[0].GroupId' --output text)
        echo "SG_ID=$SG_ID" >> $GITHUB_ENV

    - name: Launch EC2 Instance
      id: ec2
      run: |
        INSTANCE_ID=$(aws ec2 run-instances \
          --image-id ami-0c02fb55956c7d316 \
          --instance-type t2.micro \
          --key-name fastapi-key \
          --subnet-id $SUBNET_ID \
          --security-group-ids $SG_ID \
          --security-groups default \
          --associate-public-ip-address \
          --query 'Instances[0].InstanceId' --output text)

        echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

        aws ec2 wait instance-running --instance-ids $INSTANCE_ID
        PUBLIC_IP=$(aws ec2 describe-instances \
          --instance-ids $INSTANCE_ID \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        echo "EC2_PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV

    - name: Wait for SSH to Become Available
      run: |
        sleep 60  # wait for EC2 to be ready

    - name: Install FastAPI & Start App
      run: |
        ssh -o StrictHostKeyChecking=no -i fastapi-key.pem ec2-user@${{ env.EC2_PUBLIC_IP }} << 'EOF'
        sudo yum update -y
        sudo yum install git python3 -y
        python3 -m venv venv
        source venv/bin/activate
        git clone https://github.com/${{ github.repository }} app
        cd app
        pip install -r requirements.txt

        echo "DB_HOST=${{ secrets.DB_HOST }}" > .env
        echo "DB_USER=${{ secrets.DB_USER }}" >> .env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
        echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
        echo "DB_PORT=3306" >> .env

        nohup venv/bin/uvicorn backend:app --host 0.0.0.0 --port 8000 &
        EOF

    - name: Show Public URL
      run: |
        echo "âœ… Deployed at: http://${{ env.EC2_PUBLIC_IP }}:8000"
